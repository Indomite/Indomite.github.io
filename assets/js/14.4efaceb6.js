(window.webpackJsonp=window.webpackJsonp||[]).push([[14],{422:function(e,n,i){"use strict";i.r(n);var s=i(0),t=Object(s.a)({},(function(){var e=this,n=e._self._c;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("p",[e._v("EsBuildåœ¨Viteä¸­çš„åº”ç”¨\nViteç®€ä»‹\nVite æ˜¯ä¸€æ¬¾å¼€ç®±å³ç”¨çš„é›†æˆäº†å¼€å‘æœåŠ¡å™¨å’Œæ‰“åŒ…å·¥å…·çš„å‰ç«¯æ„å»ºå·¥å…·ã€‚")]),e._v(" "),n("p",[e._v("ç›¸è¾ƒäºä¼ ç»Ÿçš„æ‰“åŒ…æ„å»ºå·¥å…·ï¼ˆå¦‚ Webpackï¼‰å…ˆæ‰“åŒ…æ„å»ºå†å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ŒVite å·§å¦™åœ°åˆ©ç”¨äº†æµè§ˆå™¨å¯¹ ESM çš„æ”¯æŒï¼Œå…ˆå¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼ˆé¦–æ¬¡å¯åŠ¨æ—¶ä¼šæ‰§è¡Œä¾èµ–é¢„æ„å»ºï¼Œä¹‹åä¼šä»‹ç»ï¼‰ï¼Œå½“ä»£ç æ‰§è¡Œåˆ°æ¨¡å—åŠ è½½æ—¶å†è¯·æ±‚å¯¹åº”æ¨¡å—çš„æ–‡ä»¶ï¼ˆæ³¨ï¼šå¯¹ ESM æ¨¡å—çš„è¯·æ±‚å­˜åœ¨è·¨åŸŸé—®é¢˜ï¼‰ã€‚")]),e._v(" "),n("p",[e._v("åŸºäºæ‰“åŒ…å™¨çš„å¼€å‘æœåŠ¡å™¨åŸºäº ESM çš„å¼€å‘æœåŠ¡å™¨")]),e._v(" "),n("p",[e._v("webpack ä¼šå…ˆæ‰“åŒ…ï¼Œç„¶åå¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œè¯·æ±‚æœåŠ¡å™¨æ—¶ç›´æ¥ç»™äºˆæ‰“åŒ…ç»“æœã€‚è€Œ vite æ˜¯ç›´æ¥å¯åŠ¨å¼€å‘æœåŠ¡å™¨ï¼Œè¯·æ±‚å“ªä¸ªæ¨¡å—å†å¯¹è¯¥æ¨¡å—è¿›è¡Œå®æ—¶ç¼–è¯‘ã€‚")]),e._v(" "),n("p",[e._v("ç”±äºç°ä»£æµè§ˆå™¨æœ¬èº«å°±æ”¯æŒ ES Moduleï¼Œä¼šè‡ªåŠ¨å‘ä¾èµ–çš„ Module å‘å‡ºè¯·æ±‚ã€‚vite å……åˆ†åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œå°†å¼€å‘ç¯å¢ƒä¸‹çš„æ¨¡å—æ–‡ä»¶ï¼Œå°±ä½œä¸ºæµè§ˆå™¨è¦æ‰§è¡Œçš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯åƒ webpack é‚£æ ·è¿›è¡Œæ‰“åŒ…åˆå¹¶ã€‚")]),e._v(" "),n("p",[e._v("ç”±äº vite åœ¨å¯åŠ¨çš„æ—¶å€™ä¸éœ€è¦æ‰“åŒ…ï¼Œä¹Ÿå°±æ„å‘³ç€ä¸éœ€è¦åˆ†ææ¨¡å—çš„ä¾èµ–ã€ä¸éœ€è¦ç¼–è¯‘ï¼Œå› æ­¤å¯åŠ¨é€Ÿåº¦éå¸¸å¿«ã€‚å½“æµè§ˆå™¨è¯·æ±‚æŸä¸ªæ¨¡å—æ—¶ï¼Œå†æ ¹æ®éœ€è¦å¯¹æ¨¡å—å†…å®¹è¿›è¡Œç¼–è¯‘ã€‚è¿™ç§æŒ‰éœ€åŠ¨æ€ç¼–è¯‘çš„æ–¹å¼ï¼Œæå¤§çš„ç¼©å‡äº†ç¼–è¯‘æ—¶é—´ï¼Œé¡¹ç›®è¶Šå¤æ‚ã€æ¨¡å—è¶Šå¤šï¼Œvite çš„ä¼˜åŠ¿è¶Šæ˜æ˜¾ã€‚")]),e._v(" "),n("p",[e._v("åœ¨ HMRï¼ˆçƒ­æ›´æ–°ï¼‰æ–¹é¢ï¼Œå½“æ”¹åŠ¨äº†ä¸€ä¸ªæ¨¡å—åï¼Œä»…éœ€è®©æµè§ˆå™¨é‡æ–°è¯·æ±‚è¯¥æ¨¡å—å³å¯ï¼Œä¸åƒ webpack é‚£æ ·éœ€è¦æŠŠè¯¥æ¨¡å—çš„ç›¸å…³ä¾èµ–æ¨¡å—å…¨éƒ¨ç¼–è¯‘ä¸€æ¬¡ï¼Œæ•ˆç‡æ›´é«˜ã€‚")]),e._v(" "),n("p",[e._v("å½“éœ€è¦æ‰“åŒ…åˆ°ç”Ÿäº§ç¯å¢ƒæ—¶ï¼Œvite ä½¿ç”¨ä¼ ç»Ÿçš„ rollupï¼ˆä¹Ÿå¯ä»¥è‡ªå·±æ‰‹åŠ¨å®‰è£… webpack æ¥ï¼‰è¿›è¡Œæ‰“åŒ…ã€‚å› æ­¤ï¼Œvite çš„ä¸»è¦ä¼˜åŠ¿åœ¨å¼€å‘é˜¶æ®µã€‚å¦å¤–ï¼Œç”±äº vite åˆ©ç”¨çš„æ˜¯ ES Moduleï¼Œå› æ­¤åœ¨ä»£ç ä¸­ï¼ˆé™¤äº† vite.config.js é‡Œé¢ï¼Œè¿™é‡Œæ˜¯ node çš„æ‰§è¡Œç¯å¢ƒï¼‰ä¸å¯ä»¥ä½¿ç”¨ CommonJSã€‚")]),e._v(" "),n("p",[e._v("Vite ä¹Ÿæ˜¯åˆ©ç”¨æµè§ˆå™¨åŸç”Ÿçš„ ESM å»è§£æ importsï¼Œç„¶åå‘ devServer è¯·æ±‚æ¨¡å—ï¼Œåœ¨æœåŠ¡å™¨ç«¯ä½¿ç”¨ esbuild å¯¹æ¨¡å—è¿›è¡Œå³æ—¶ç¼–è¯‘åè¿”å›(ä¸»è¦æ˜¯è½¬æ¢.jsx,.tsx,.vue,.lessç­‰æµè§ˆå™¨æ— æ³•å¤„ç†çš„æ–‡ä»¶ï¼Œè€Œä¸æ˜¯ç¼–è¯‘ä¸º ES5 å…¼å®¹è€æ—§æµè§ˆå™¨ï¼‰ã€‚")]),e._v(" "),n("p",[e._v("ä¾èµ–é¢„ç¼–è¯‘\nä¾èµ–é¢„æ„å»ºï¼ˆDependency Pre-Bundlingï¼‰ã€‚æŒ‡çš„æ˜¯ Vite ä¼šåœ¨ DevServer å¯åŠ¨å‰å¯¹éœ€è¦é¢„æ„å»ºçš„ä¾èµ–è¿›è¡Œæ„å»ºï¼Œç„¶ååœ¨åˆ†ææ¨¡å—çš„å¯¼å…¥ï¼ˆimportï¼‰æ—¶ä¼šåŠ¨æ€åœ°åº”ç”¨æ„å»ºè¿‡çš„ä¾èµ–ã€‚")]),e._v(" "),n("p",[e._v("é‚£ä¹ˆï¼Œä»Šå¤©æœ¬æ–‡å°†ä¼šå›´ç»•ä»¥ä¸‹ 3 ç‚¹æ¥å’Œå¤§å®¶ä¸€èµ·ä»ç–‘é—®ç‚¹å‡ºå‘ï¼Œæ·±å…¥æµ…å‡ºä¸€ç•ª Vite çš„ä¾èµ–é¢„æ„å»ºè¿‡ç¨‹ï¼š")]),e._v(" "),n("p",[e._v("ä»€ä¹ˆæ˜¯ä¾èµ–é¢„æ„å»º")]),e._v(" "),n("p",[e._v("ä¾èµ–é¢„æ„å»ºçš„ä½œç”¨")]),e._v(" "),n("p",[e._v("ä¾èµ–é¢„æ„å»ºçš„å®ç°ï¼ˆæºç åˆ†æï¼‰")]),e._v(" "),n("p",[e._v("ä¸€ã€ä»€ä¹ˆæ˜¯ä¾èµ–é¢„æ„å»º\nå½“ä½ åœ¨é¡¹ç›®ä¸­å¼•ç”¨äº† vue å’Œ lodash-esï¼Œé‚£ä¹ˆä½ åœ¨å¯åŠ¨ Vite çš„æ—¶å€™ï¼Œä½ ä¼šåœ¨ç»ˆç«¯çœ‹åˆ°è¿™æ ·çš„è¾“å‡ºå†…å®¹ï¼š")]),e._v(" "),n("p",[e._v("æŠ€æœ¯åœˆå­ > ESBuildåœ¨Viteä¾èµ–é¢„æ„å»ºåŸç† > image2021-8-25_16-15-55.png")]),e._v(" "),n("p",[e._v("è€Œè¿™è¡¨ç¤º Vite å°†ä½ åœ¨é¡¹ç›®ä¸­å¼•å…¥çš„ vue å’Œ lodash-es è¿›è¡Œäº†ä¾èµ–é¢„æ„å»ºï¼š")]),e._v(" "),n("p",[e._v("é»˜è®¤æƒ…å†µä¸‹ï¼ŒVite ä¼šå°† package.json ä¸­ç”Ÿäº§ä¾èµ– dependencies çš„éƒ¨åˆ†å¯ç”¨ä¾èµ–é¢„æ„å»ºï¼Œå³ä¼šå…ˆå¯¹è¯¥ä¾èµ–è¿›è¡Œæ„å»ºï¼Œç„¶åå°†æ„å»ºåçš„æ–‡ä»¶ç¼“å­˜åœ¨å†…å­˜ä¸­ï¼ˆnode_modules/.vite æ–‡ä»¶ä¸‹ï¼‰ï¼Œåœ¨å¯åŠ¨ DevServer æ—¶ç›´æ¥è¯·æ±‚è¯¥ç¼“å­˜å†…å®¹ã€‚")]),e._v(" "),n("p",[e._v("åœ¨ vite.config.js æ–‡ä»¶ä¸­é…ç½® optimizeDeps é€‰é¡¹å¯ä»¥é€‰æ‹©éœ€è¦æˆ–ä¸éœ€è¦è¿›è¡Œé¢„æ„å»ºçš„ä¾èµ–çš„åç§°ï¼ŒVite åˆ™ä¼šæ ¹æ®è¯¥é€‰é¡¹æ¥ç¡®å®šæ˜¯å¦å¯¹è¯¥ä¾èµ–è¿›è¡Œé¢„æ„å»ºã€‚")]),e._v(" "),n("p",[e._v("åœ¨å¯åŠ¨æ—¶æ·»åŠ  --force optionsï¼Œå¯ä»¥ç”¨æ¥å¼ºåˆ¶é‡æ–°è¿›è¡Œä¾èµ–é¢„æ„å»ºã€‚")]),e._v(" "),n("p",[e._v("é‚£ä¹ˆï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥äº†è§£ä¸€ä¸‹ä¾èµ–é¢„æ„å»ºçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œå³ä¼˜åŒ–çš„æ„ä¹‰")]),e._v(" "),n("p",[e._v("äºŒã€ä¾èµ–é¢„æ„å»ºçš„ä½œç”¨")]),e._v(" "),n("ol",[n("li",[e._v("å…¼å®¹ CommonJS å’Œ AMD æ¨¡å—çš„ä¾èµ–")])]),e._v(" "),n("p",[e._v("å› ä¸º Vite çš„ DevServer æ˜¯åŸºäºæµè§ˆå™¨çš„ Natvie ES Module å®ç°çš„ï¼Œæ‰€ä»¥å¯¹äºä½¿ç”¨çš„ä¾èµ–å¦‚æœæ˜¯ CommonJS æˆ– AMD çš„æ¨¡å—ï¼Œåˆ™éœ€è¦è¿›è¡Œæ¨¡å—ç±»å‹çš„è½¬åŒ–ï¼ˆES Moduleï¼‰ã€‚")]),e._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[e._v("å‡å°‘æ¨¡å—é—´ä¾èµ–å¼•ç”¨å¯¼è‡´è¿‡å¤šçš„è¯·æ±‚æ¬¡æ•°")])]),e._v(" "),n("p",[e._v("é€šå¸¸æˆ‘ä»¬å¼•å…¥çš„ä¸€äº›ä¾èµ–ï¼Œå®ƒè‡ªå·±åˆä¼šä¸€äº›å…¶ä»–ä¾èµ–ã€‚å®˜æ–¹æ–‡æ¡£ä¸­ä¸¾äº†ä¸€ä¸ªå¾ˆç»å…¸çš„ä¾‹å­ï¼Œå½“æˆ‘ä»¬åœ¨é¡¹ç›®ä¸­ä½¿ç”¨ lodash-es çš„æ—¶å€™ï¼š")]),e._v(" "),n("p",[e._v('import { debounce } from "lodash-es"\nlodash è¯·æ±‚ä¾èµ–é“¾è·¯')]),e._v(" "),n("p",[e._v("å¦‚æœåœ¨æ²¡ç”¨ä¾èµ–é¢„æ„å»ºçš„æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰“å¼€é¡µé¢çš„ Dev Tool çš„ Network é¢æ¿ï¼š")]),e._v(" "),n("p",[e._v("æŠ€æœ¯åœˆå­ > ESBuildåœ¨Viteä¾èµ–é¢„æ„å»ºåŸç† > image2021-8-25_16-9-30.png")]),e._v(" "),n("p",[e._v("å¯ä»¥çœ‹åˆ°æ­¤æ—¶å¤§æ¦‚æœ‰ 600+ å’Œ lodash-es ç›¸å…³çš„è¯·æ±‚ï¼Œå¹¶ä¸”æ‰€æœ‰è¯·æ±‚åŠ è½½èŠ±äº† 3.43 sï¼Œä¼¼ä¹è¿˜å¥½ï¼Ÿç°åœ¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ä½¿ç”¨ä¾èµ–é¢„æ„å»ºçš„æƒ…å†µï¼š")]),e._v(" "),n("p",[e._v("æŠ€æœ¯åœˆå­ > ESBuildåœ¨Viteä¾èµ–é¢„æ„å»ºåŸç† > image2021-8-25_16-8-50.png")]),e._v(" "),n("p",[e._v("æ­¤æ—¶ï¼Œåªæœ‰ 1 ä¸ªå’Œ lodash-es ç›¸å…³çš„è¯·æ±‚ï¼ˆç»è¿‡é¢„æ„å»ºï¼‰ï¼Œå¹¶ä¸”æ‰€æœ‰è¯·æ±‚åŠ è½½æ‰èŠ±äº† 338 msï¼Œç¼©çŸ­äº†è¶³è¶³ 10 å€å¤šçš„æ—¶é—´ï¼ è€Œè¿™é‡ŒèŠ‚çœçš„æ—¶é—´ï¼Œå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„å†·å¯åŠ¨æ—¶é—´ã€‚")]),e._v(" "),n("p",[e._v("é‚£ä¹ˆï¼Œåˆ°è¿™é‡Œæˆ‘ä»¬å°±å·²ç»äº†è§£äº† Vite ä¾èµ–é¢„æ„å»ºæ¦‚å¿µå’Œä½œç”¨ã€‚ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ·±å…¥ Vite æºç æ¥æ›´è¿›ä¸€æ­¥åœ°è®¤è¯†ä¾èµ–é¢„æ„å»ºè¿‡ç¨‹ï¼")]),e._v(" "),n("p",[e._v("ä¸‰ã€ä¾èµ–é¢„æ„å»ºçš„å®ç°\nåœ¨ Vite æºç ä¸­ï¼Œé»˜è®¤çš„ä¾èµ–é¢„æ„å»ºè¿‡ç¨‹ä¼šåœ¨ DevServer å¼€å¯ä¹‹å‰è¿›è¡Œã€‚è¿™é‡Œï¼Œæˆ‘ä»¬ä»ç„¶ä»¥åœ¨é¡¹ç›®ä¸­å¼•å…¥äº† vue å’Œ lodash-es ä¾èµ–ä¸ºä¾‹ã€‚")]),e._v(" "),n("p",[e._v("éœ€è¦æ³¨æ„çš„æ˜¯ä»¥ä¸‹å’Œæºç ç›¸å…³çš„å‡½æ•°éƒ½æ˜¯å–çš„æ ¸å¿ƒé€»è¾‘è®²è§£ï¼ˆä¼ªä»£ç ï¼‰ã€‚")]),e._v(" "),n("p",[e._v("3.1 Dev Server å¯åŠ¨å‰\né¦–å…ˆï¼ŒVite ä¼šåˆ›å»ºä¸€ä¸ª DevServerï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¹³å¸¸ä½¿ç”¨çš„æœ¬åœ°å¼€å‘æœåŠ¡å™¨ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯ç”± createServer å‡½æ•°å®Œæˆï¼š")]),e._v(" "),n("p",[e._v("// packages/vite/src/node/server/index.ts\nasync function createServer( inlineConfig: InlineConfig = {} ): Promise"),n("ViteDevServer",[e._v(" {\n...\n// é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¼šå‘½ä¸­è¿™ä¸ªé€»è¾‘\nif (!middlewareMode && httpServer) {\n// é‡å†™ DevServer çš„ listenï¼Œä¿è¯åœ¨ DevServer å¯åŠ¨å‰è¿›è¡Œä¾èµ–é¢„æ„å»º\nconst listen = httpServer.listen.bind(httpServer)\nhttpServer.listen = (async (port: number, ...args: any[]) => {\ntry {\n...\n// ä¾èµ–é¢„æ„å»ºç›¸å…³\nawait runOptimize()\n}\n...\n}) as any\n...\n} else {\nawait runOptimize()\n}\n...\n}\nå¯ä»¥çœ‹åˆ°åœ¨ DevServer çœŸæ­£å¯åŠ¨ä¹‹å‰ï¼Œå®ƒä¼šå…ˆè°ƒç”¨ runOptimize å‡½æ•°ï¼Œè¿›è¡Œä¾èµ–é¢„æ„å»ºç›¸å…³çš„å¤„ç†ã€‚")])],1),e._v(" "),n("p",[e._v("runOptimize å‡½æ•°ï¼š\n// packages/vite/src/node/server/index.ts\nconst runOptimize = async () => {\n// config.optimzizeCacheDir æŒ‡çš„æ˜¯ node_modules/.vite\nif (config.optimizeCacheDir) {\n..\ntry {\nserver._optimizeDepsMetadata = await optimizeDeps(config)\n}\n..\nserver._registerMissingImport = createMissingImpoterRegisterFn(server)\n}\n}\nrunOptimize å‡½æ•°è´Ÿè´£çš„æ˜¯è°ƒç”¨å’Œæ³¨å†Œå¤„ç†ä¾èµ–é¢„æ„å»ºç›¸å…³çš„ optimizeDeps å‡½æ•°ï¼Œå…·ä½“æ¥è¯´ä¼šæ˜¯ä¸¤ä»¶äº‹ï¼š")]),e._v(" "),n("ol",[n("li",[e._v("è¿›è¡Œä¾èµ–é¢„æ„å»º")])]),e._v(" "),n("p",[e._v("optimizeDeps å‡½æ•°æ˜¯ Vite å®ç°ä¾èµ–é¢„æ„å»ºçš„æ ¸å¿ƒå‡½æ•°ï¼Œå®ƒä¼šæ ¹æ®é…ç½® vite.config.js çš„ optimizeDeps é€‰é¡¹å’Œ package.json çš„ dependencies çš„å‚æ•°è¿›è¡Œç¬¬ä¸€æ¬¡é¢„æ„å»ºã€‚å®ƒä¼šè¿”å›è§£æ node_moduels/.vite/_metadata.json æ–‡ä»¶åç”Ÿæˆçš„å¯¹è±¡ï¼ˆåŒ…å«é¢„æ„å»ºåçš„ä¾èµ–æ‰€åœ¨çš„æ–‡ä»¶ä½ç½®ã€åŸæ–‡ä»¶æ‰€å¤„çš„æ–‡ä»¶ä½ç½®ç­‰ï¼‰ã€‚")]),e._v(" "),n("p",[e._v("ä¹‹æ‰€ä»¥è¦è¿›è¡Œé‡å†™çš„ç¼˜ç”±æ˜¯å› ä¸º CommonJS çš„æ¨¡å—å¹¶ä¸æ”¯æŒå‘½åæ–¹å¼çš„å¯¼å‡ºã€‚æ‰€ä»¥ï¼Œå¦‚æœä¸ç»è¿‡æ’ä»¶çš„è½¬åŒ–ï¼Œåˆ™ä¼šçœ‹åˆ°è¿™æ ·çš„å¼‚å¸¸ï¼š")]),e._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[e._v("æ³¨å†Œä¾èµ–é¢„æ„å»ºç›¸å…³å‡½æ•°")])]),e._v(" "),n("p",[e._v("è°ƒç”¨ createMissingImpoterRegisterFn å‡½æ•°ï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ªå‡½æ•°ï¼Œå…¶ä»ç„¶å†…éƒ¨ä¼šè°ƒç”¨ optimizeDeps å‡½æ•°è¿›è¡Œé¢„æ„å»ºï¼Œåªæ˜¯ä¸åŒäºç¬¬ä¸€æ¬¡é¢„æ„å»ºè¿‡ç¨‹ï¼Œæ­¤æ—¶ä¼šä¼ äººä¸€ä¸ª newDepsï¼Œå³æ–°çš„éœ€è¦è¿›è¡Œé¢„æ„å»ºçš„ä¾èµ–ã€‚")]),e._v(" "),n("p",[e._v("é‚£ä¹ˆï¼Œæ˜¾ç„¶æ— è®ºæ˜¯ç¬¬ä¸€æ¬¡é¢„æ„å»ºï¼Œè¿˜æ˜¯åç»­çš„é¢„æ„å»ºï¼Œå®ƒä»¬ä¸¤è€…çš„å®ç°éƒ½æ˜¯è°ƒç”¨çš„ optimizeDeps å‡½æ•°ã€‚æ‰€ä»¥ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹ optimizeDeps å‡½æ•°ï½")]),e._v(" "),n("p",[e._v("3.2 é¢„æ„å»ºå®ç°æ ¸å¿ƒ optimizeDeps å‡½æ•°\noptimizeDeps å‡½æ•°è¢«å®šä¹‰åœ¨ packages/vite/node/optimizer/index.ts ä¸­ï¼Œå®ƒè´Ÿè´£å¯¹ä¾èµ–è¿›è¡Œé¢„æ„å»ºè¿‡ç¨‹ï¼š")]),e._v(" "),n("p",[e._v("// packages/vite/node/optimizer/index.ts\nexport async function optimizeDeps( config: ResolvedConfig, force = config.server.force, asCommand = false, newDeps?: Record<string, string> ): Promise<DepOptimizationMetadata | null> {\n...\n}\nç”±äº optimizeDeps å†…éƒ¨é€»è¾‘è¾ƒä¸ºç¹å¤šï¼Œè¿™é‡Œæˆ‘ä»¬æ‹†åˆ†ä¸º 5 ä¸ªæ­¥éª¤è®²è§£ï¼š")]),e._v(" "),n("ol",[n("li",[e._v("è¯»å–è¯¥ä¾èµ–æ­¤æ—¶çš„æ–‡ä»¶ä¿¡æ¯")])]),e._v(" "),n("p",[e._v("æ—¢ç„¶æ˜¯æ„å»ºä¾èµ–ï¼Œå¾ˆæ˜¾ç„¶çš„æ˜¯æ¯æ¬¡æ„å»ºéƒ½éœ€è¦çŸ¥é“æ­¤æ—¶æ–‡ä»¶å†…å®¹å¯¹åº”çš„ Hash å€¼ï¼Œä»¥ä¾¿äºä¾èµ–å‘ç”Ÿå˜åŒ–æ—¶å¯ä»¥é‡æ–°è¿›è¡Œä¾èµ–æ„å»ºï¼Œä»è€Œåº”ç”¨æœ€æ–°çš„ä¾èµ–å†…å®¹ã€‚")]),e._v(" "),n("p",[e._v("æ‰€ä»¥ï¼Œè¿™é‡Œä¼šå…ˆè°ƒç”¨ getDepHash å‡½æ•°è·å–ä¾èµ–çš„ Hash å€¼ï¼š")]),e._v(" "),n("p",[e._v("// è·å–è¯¥æ–‡ä»¶æ­¤æ—¶çš„ hash\nconst mainHash = getDepHash(root, config)\nconst data: DepOptimizationMetadata = {\nhash: mainHash,\nbrowserHash: mainHash,\noptimized: {}\n}\nè€Œå¯¹äº data ä¸­çš„è¿™ä¸‰ä¸ªå±æ€§ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢å·²ç»ä»‹ç»è¿‡äº†ï¼Œè¿™é‡Œå°±ä¸é‡å¤è®ºè¿°äº†ï½")]),e._v(" "),n("ol",{attrs:{start:"2"}},[n("li",[e._v("å¯¹æ¯”ç¼“å­˜æ–‡ä»¶çš„ Hash")])]),e._v(" "),n("p",[e._v("å‰é¢ï¼Œæˆ‘ä»¬ä¹ŸæåŠäº†å¦‚æœå¯åŠ¨ Vite æ—¶ä½¿ç”¨äº† --force Optionï¼Œåˆ™ä¼šå¼ºåˆ¶é‡æ–°è¿›è¡Œä¾èµ–é¢„æ„å»ºã€‚æ‰€ä»¥ï¼Œå½“ä¸æ˜¯ --force åœºæ™¯æ—¶ï¼Œåˆ™ä¼šè¿›è¡Œæ¯”è¾ƒæ–°æ—§ä¾èµ–çš„ Hash å€¼çš„è¿‡ç¨‹ï¼š")]),e._v(" "),n("p",[e._v("// é»˜è®¤ä¸º false\nif (!force) {\nlet prevData\ntry {\n// è·å–åˆ°æ­¤æ—¶ç¼“å­˜ï¼ˆæœ¬åœ°ç£ç›˜ï¼‰ä¸­æ„å»ºçš„æ–‡ä»¶ä¿¡æ¯\nprevData = JSON.parse(fs.readFileSync(dataPath, 'utf-8'))\n} catch (e) {}\n// å¯¹æ¯”æ­¤æ—¶çš„\nif (prevData && prevData.hash === data.hash) {\nlog('Hash is consistent. Skipping. Use --force to override.')\nreturn prevData\n}\n}")]),e._v(" "),n("p",[e._v("å¯ä»¥çœ‹åˆ°å¦‚æœæ–°æ—§ä¾èµ–çš„ Hash å€¼ç›¸ç­‰çš„æ—¶å€™ï¼Œåˆ™ä¼šç›´æ¥è¿”å›æ—§çš„ä¾èµ–å†…å®¹ã€‚")]),e._v(" "),n("ol",{attrs:{start:"3"}},[n("li",[e._v("ç¼“å­˜å¤±æ•ˆæˆ–æœªç¼“å­˜")])]),e._v(" "),n("p",[e._v("å¦‚æœä¸Šé¢çš„ Hash ä¸ç­‰ï¼Œåˆ™è¡¨ç¤ºç¼“å­˜å¤±æ•ˆï¼Œæ‰€ä»¥ä¼šåˆ é™¤ cacheDir æ–‡ä»¶å¤¹ï¼Œåˆæˆ–è€…æ­¤æ—¶æœªè¿›è¡Œç¼“å­˜ï¼Œå³ç¬¬ä¸€æ¬¡ä¾èµ–é¢„æ„å»ºé€»è¾‘ï¼ˆ cacheDir æ–‡ä»¶å¤¹ä¸å­˜åœ¨ï¼‰ï¼Œåˆ™åˆ›å»º cacheDir æ–‡ä»¶å¤¹ï¼š")]),e._v(" "),n("p",[e._v("if (fs.existsSync(cacheDir)) {\nemptyDir(cacheDir)\n} else {\nfs.mkdirSync(cacheDir, { recursive: true })\n}\néœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œçš„ cacheDir åˆ™æŒ‡çš„æ˜¯ node_modules/.vite æ–‡ä»¶å¤¹")]),e._v(" "),n("p",[e._v("å‰é¢åœ¨è®² DevServer å¯åŠ¨æ—¶ï¼Œæˆ‘ä»¬æåŠé¢„æ„å»ºè¿‡ç¨‹ä¼šåˆ†ä¸ºä¸¤ç§ï¼šç¬¬ä¸€æ¬¡é¢„æ„å»ºå’Œåç»­çš„é¢„æ„å»ºã€‚ä¸¤è€…çš„åŒºåˆ«åœ¨äºåè€…ä¼šä¼ å…¥ä¸€ä¸ª newDepsï¼Œå®ƒè¡¨ç¤ºæ–°çš„éœ€è¦è¿›è¡Œé¢„æ„å»ºçš„ä¾èµ–ï¼š")]),e._v(" "),n("p",[e._v("let deps: Record<string, string>, missing: Record<string, string>\nif (!newDeps) {\nğŸ˜­{ deps, missing } = await scanImports(config))\n} else {\n// å­˜åœ¨ newDeps çš„æ—¶å€™ï¼Œç›´æ¥å°† newDeps èµ‹å€¼ç»™ deps\ndeps = newDeps\nmissing = {}\n}")]),e._v(" "),n("p",[e._v("å¹¶ä¸”ï¼Œè¿™é‡Œå¯ä»¥çœ‹åˆ°å¯¹äºå‰è€…ï¼Œç¬¬ä¸€æ¬¡é¢„æ„å»ºï¼Œåˆ™ä¼šè°ƒç”¨ scanImports å‡½æ•°æ¥æ‰¾å‡ºå’Œé¢„æ„å»ºç›¸å…³çš„ä¾èµ– depsï¼Œdeps ä¼šæ˜¯ä¸€ä¸ªå¯¹è±¡ï¼š")]),e._v(" "),n("p",[e._v("{\nlodash-es:'/Users/wjc/Documents/FE/demos/vite2.0-demo/node_modules/lodash-es/lodash.js'\nvue:'/Users/wjc/Documents/FE/demos/vite2.0-demo/node_modules/vue/dist/vue.runtime.esm-bundler.js'\n}")]),e._v(" "),n("p",[e._v("è€Œ missing åˆ™è¡¨ç¤ºåœ¨ node_modules ä¸­æ²¡æ‰¾åˆ°çš„ä¾èµ–ã€‚æ‰€ä»¥ï¼Œå½“ missing å­˜åœ¨æ—¶ï¼Œä½ ä¼šçœ‹åˆ°è¿™æ ·çš„æç¤ºï¼šå¯¼å…¥äº†ä¾èµ–ä½†æ˜¯æ²¡æœ‰ä½¿ç”¨")]),e._v(" "),n("p",[e._v("é‚£ä¹ˆï¼Œå›åˆ°ä¸Šé¢å¯¹äºåè€…ï¼ˆnewDeps å­˜åœ¨æ—¶ï¼‰çš„é€»è¾‘åˆ™è¾ƒä¸ºç®€å•ï¼Œä¼šç›´æ¥ç»™ deps èµ‹å€¼ä¸º newDepsï¼Œå¹¶ä¸”ä¸éœ€è¦å¤„ç† missingã€‚å› ä¸ºï¼ŒnewDeps åªæœ‰åœ¨åç»­å¯¼å…¥å¹¶å®‰è£…äº†æ–°çš„ dependencies ä¾èµ–ï¼Œæ‰ä¼šä¼ å…¥çš„ï¼Œæ­¤æ—¶æ˜¯ä¸å­˜åœ¨ missing çš„ä¾èµ–çš„ï¼ˆ Vite å†…ç½®çš„ importAnalysisPlugin æ’ä»¶ä¼šæå‰è¿‡æ»¤æ‰è¿™äº›ï¼‰ã€‚")]),e._v(" "),n("ol",{attrs:{start:"4"}},[n("li",[e._v("å¤„ç† optimizeDeps.include ç›¸å…³ä¾èµ–")])]),e._v(" "),n("p",[e._v("åœ¨å‰é¢ï¼Œæˆ‘ä»¬ä¹ŸæåŠäº†éœ€è¦è¿›è¡Œæ„å»ºçš„ä¾èµ–ä¹Ÿä¼šç”± vite.config.js çš„ optimizeDeps é€‰é¡¹å†³å®šã€‚æ‰€ä»¥ï¼Œåœ¨å¤„ç†å®Œ dependencies ä¹‹åï¼Œæ¥ç€éœ€è¦å¤„ç† optimizeDepsã€‚")]),e._v(" "),n("p",[e._v("æ­¤æ—¶ï¼Œä¼šéå†å‰é¢ä» dependencies è·å–åˆ°çš„ depsï¼Œåˆ¤æ–­ optimizeDeps.icludeï¼ˆæ•°ç»„ï¼‰æ‰€æŒ‡å®šçš„ä¾èµ–æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š")]),e._v(" "),n("p",[e._v("const include = config.optimizeDeps?.include\nif (include) {\nconst resolve = config.createResolver({ asSrc: false })\nfor (const id of include) {\nif (!deps[id]) {\nconst entry = await resolve(id)\nif (entry) {\ndeps[id] = entry\n} else {\nthrow new Error(\n"),n("code",[e._v("Failed to resolve force included dependency: ${chalk.cyan(id)}")]),e._v("\n)\n}\n}\n}\n}")]),e._v(" "),n("ol",{attrs:{start:"5"}},[n("li",[e._v("ä½¿ç”¨ esbuild æ„å»ºä¾èµ–")])]),e._v(" "),n("p",[e._v("é‚£ä¹ˆï¼Œåœ¨åšå¥½ä¸Šè¿°å’Œé¢„æ„å»ºä¾èµ–ç›¸å…³çš„å¤„ç†ï¼ˆæ–‡ä»¶ hash ç”Ÿæˆã€é¢„æ„å»ºä¾èµ–ç¡®å®šç­‰ï¼‰åã€‚åˆ™è¿›å…¥ä¾èµ–é¢„æ„å»ºçš„æœ€åä¸€æ­¥ï¼Œä½¿ç”¨ esbuild æ¥å¯¹ç›¸åº”çš„ä¾èµ–è¿›è¡Œæ„å»ºï¼š")]),e._v(" "),n("p",[e._v("...\nconst esbuildService = await ensureService()\nawait esbuildService.build({\nentryPoints: Object.keys(flatIdDeps),\nbundle: true,\nformat: 'esm',\n...\n})\n...\nensureService å‡½æ•°æ˜¯ Vite å†…éƒ¨å°è£…çš„ utilï¼Œå®ƒçš„æœ¬è´¨æ˜¯åˆ›å»ºä¸€ä¸ª esbuild çš„ serviceï¼Œä½¿ç”¨ service.build å‡½æ•°æ¥å®Œæˆæ„å»ºè¿‡ç¨‹ã€‚")]),e._v(" "),n("p",[e._v("æ­¤æ—¶ï¼Œä¼ å…¥çš„ flatIdDeps å‚æ•°æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå®ƒæ˜¯ç”±ä¸Šé¢æåŠçš„ deps æ”¶é›†å¥½çš„ä¾èµ–åˆ›å»ºçš„ï¼Œå®ƒçš„ä½œç”¨æ˜¯ä¸º esbuild è¿›è¡Œæ„å»ºçš„æ—¶å€™æä¾›å¤šè·¯å£ï¼ˆentryï¼‰ï¼ŒflatIdDeps å¯¹è±¡ï¼š")]),e._v(" "),n("p",[e._v("{\nlodash-es:'/Users/wjc/Documents/FE/demos/vite2.0-demo/node_modules/lodash-es/lodash.js'\nmoment:'/Users/wjc/Documents/FE/demos/vite2.0-demo/node_modules/moment/dist/moment.js'\nvue:'/Users/wjc/Documents/FE/demos/vite2.0-demo/node_modules/vue/dist/vue.runtime.esm-bundler.js'\n}\nåˆ°æ­¤æˆ‘ä»¬å·²ç»åˆ†æå®Œäº†æ•´ä¸ªä¾èµ–é¢„æ„å»ºçš„å®ç°")]),e._v(" "),n("p",[e._v("é‚£ä¹ˆï¼Œæ¥ä¸‹æ¥åœ¨ DevServer å¯åŠ¨åï¼Œå½“æ¨¡å—éœ€è¦è¯·æ±‚ç»è¿‡é¢„æ„å»ºçš„ä¾èµ–çš„æ—¶å€™ï¼ŒVite å†…éƒ¨çš„ resolvePlugin æ’ä»¶ä¼šè§£æè¯¥ä¾èµ–æ˜¯å¦å­˜åœ¨ seen ä¸­ï¼ˆseen ä¸­ä¼šå­˜å‚¨æ„å»ºè¿‡çš„ä¾èµ–æ˜ å°„ï¼‰ï¼Œç›´æ¥åº”ç”¨ node_modules/.vite ç›®å½•ä¸‹å¯¹åº”çš„æ„å»ºåçš„ä¾èµ–ï¼Œé¿å…ç›´æ¥å»è¯·æ±‚æ„å»ºå‰çš„ä¾èµ–çš„æƒ…å†µå‡ºç°ï¼Œä»è€Œç¼©çŸ­å†·å¯åŠ¨çš„æ—¶é—´ã€‚")]),e._v(" "),n("p",[e._v("å‚è€ƒæ–‡æ¡£ï¼š")]),e._v(" "),n("p",[e._v("https://github.com/lgwebdream/FE-Interview/issues/1180")]),e._v(" "),n("p",[e._v("https://zhuanlan.zhihu.com/p/352403391")])])}),[],!1,null,null,null);n.default=t.exports}}]);